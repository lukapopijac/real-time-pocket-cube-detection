/**
 * @license almond 0.3.1 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

(function(){var e,t,n;(function(r){function v(e,t){return h.call(e,t)}function m(e,t){var n,r,i,s,o,u,a,f,c,h,p,v=t&&t.split("/"),m=l.map,g=m&&m["*"]||{};if(e&&e.charAt(0)===".")if(t){e=e.split("/"),o=e.length-1,l.nodeIdCompat&&d.test(e[o])&&(e[o]=e[o].replace(d,"")),e=v.slice(0,v.length-1).concat(e);for(c=0;c<e.length;c+=1){p=e[c];if(p===".")e.splice(c,1),c-=1;else if(p===".."){if(c===1&&(e[2]===".."||e[0]===".."))break;c>0&&(e.splice(c-1,2),c-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((v||g)&&m){n=e.split("/");for(c=n.length;c>0;c-=1){r=n.slice(0,c).join("/");if(v)for(h=v.length;h>0;h-=1){i=m[v.slice(0,h).join("/")];if(i){i=i[r];if(i){s=i,u=c;break}}}if(s)break;!a&&g&&g[r]&&(a=g[r],f=c)}!s&&a&&(s=a,u=f),s&&(n.splice(0,u,s),e=n.join("/"))}return e}function g(e,t){return function(){var n=p.call(arguments,0);return typeof n[0]!="string"&&n.length===1&&n.push(null),s.apply(r,n.concat([e,t]))}}function y(e){return function(t){return m(t,e)}}function b(e){return function(t){a[e]=t}}function w(e){if(v(f,e)){var t=f[e];delete f[e],c[e]=!0,i.apply(r,t)}if(!v(a,e)&&!v(c,e))throw new Error("No "+e);return a[e]}function E(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function S(e){return function(){return l&&l.config&&l.config[e]||{}}}var i,s,o,u,a={},f={},l={},c={},h=Object.prototype.hasOwnProperty,p=[].slice,d=/\.js$/;o=function(e,t){var n,r=E(e),i=r[0];return e=r[1],i&&(i=m(i,t),n=w(i)),i?n&&n.normalize?e=n.normalize(e,y(t)):e=m(e,t):(e=m(e,t),r=E(e),i=r[0],e=r[1],i&&(n=w(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},u={require:function(e){return g(e)},exports:function(e){var t=a[e];return typeof t!="undefined"?t:a[e]={}},module:function(e){return{id:e,uri:"",exports:a[e],config:S(e)}}},i=function(e,t,n,i){var s,l,h,p,d,m=[],y=typeof n,E;i=i||e;if(y==="undefined"||y==="function"){t=!t.length&&n.length?["require","exports","module"]:t;for(d=0;d<t.length;d+=1){p=o(t[d],i),l=p.f;if(l==="require")m[d]=u.require(e);else if(l==="exports")m[d]=u.exports(e),E=!0;else if(l==="module")s=m[d]=u.module(e);else if(v(a,l)||v(f,l)||v(c,l))m[d]=w(l);else{if(!p.p)throw new Error(e+" missing "+l);p.p.load(p.n,g(i,!0),b(l),{}),m[d]=a[l]}}h=n?n.apply(a[e],m):undefined;if(e)if(s&&s.exports!==r&&s.exports!==a[e])a[e]=s.exports;else if(h!==r||!E)a[e]=h}else e&&(a[e]=n)},e=t=s=function(e,t,n,a,f){if(typeof e=="string")return u[e]?u[e](t):w(o(e,t).f);if(!e.splice){l=e,l.deps&&s(l.deps,l.callback);if(!t)return;t.splice?(e=t,t=n,n=null):e=r}return t=t||function(){},typeof n=="function"&&(n=a,a=f),a?i(r,e,t,n):setTimeout(function(){i(r,e,t,n)},4),s},s.config=function(e){return s(e)},e._defined=a,n=function(e,t,n){if(typeof e!="string")throw new Error("See almond README: incorrect module build, no module name");t.splice||(n=t,t=[]),!v(a,e)&&!v(f,e)&&(f[e]=[e,t,n])},n.amd={jQuery:!0}})(),n("almond.js",function(){}),n("linear_algebra",["require","exports","module"],function(e,t,n){function r(e,t){this.x=e,this.y=t}function i(e,t){this.x=e,this.y=t}function s(e,t){return e.x*t.x+e.y*t.y}function o(e,t){return e.x*t.y-e.y*t.x}function u(e){return e.x*e.x+e.y*e.y}function a(e){return Math.sqrt(e.x*e.x+e.y*e.y)}function f(e,t){var n=s(e,t),r=u(e)*u(t);return n/Math.sqrt(r)}function l(e,t){var n=e.x*t.y-e.y*t.x,r=u(e)*u(t);return n*n/r}function c(e,t){return new r(e.x+t.x,e.y+t.y)}function h(e,t){return new r(e.x-t.x,e.y-t.y)}function p(e,t){return new r(.5*(e.x-t.x),.5*(e.y-t.y))}function d(e,t,n,r,i,s){this.a=r-t,this.b=e-n,this.c=i==null?e*r-n*t:this.a*i+this.b*s}r.prototype.toString=function(){return this.x.toFixed(3)+", "+this.y.toFixed(3)},d.prototype.intersect=function(e){var t=1/(this.a*e.b-this.b*e.a),n=this.c*e.b-this.b*e.c,r=this.a*e.c-this.c*e.a;return new i(n*t,r*t)},d.prototype.distance=function(e,t){var n=this.a,r=this.b,i=n*e+r*t-this.c;return Math.sqrt(i*i/(n*n+r*r))},t.Vector=r,t.Point=i,t.cosine=f,t.sine2=l,t.magnitude2=u,t.magnitude=a,t.vectorAdd=c,t.vectorSubtract=h,t.dotProduct=s,t.crossProductVal=o,t.Line=d}),n("shape",["require","exports","module","linear_algebra"],function(e,t,n){function s(){this.x=[],this.y=[],this.area=0}function o(e,t){var n=new s,r=0,i,o,a=e.length-1;for(var f=r;t[r]===t[f];o=f++);for(var f=a;t[a]===t[f];i=f--);var c=u(r,i,e,t,-1),h=u(o,a,e,t,1);i===a&&h.length--;var p=c.concat(h.reverse());r===o&&p.length--;for(var f=0;f<p.length;++f)n.x.push(e[p[f]]),n.y.push(t[p[f]]);return n.area=l(n),n}function u(e,t,n,r,i){var s=[e];for(var o=e+1;o<=t;++o){var u=n[o],a=r[o],f=s.length-1;while(f){var l=s[f-1],c=s[f],h=n[l],p=r[l],d=n[c],v=r[c],m=v-p,g=h-d,y=m*(u-h)+g*(a-p);if(i*y<0)break;--f}s.length=f+1,s.push(o)}return s}function a(e){var t=new s,n=e.x.slice(0),i=e.y.slice(0);for(;;){var o=n.length,u=1,a=-1;for(var c=0;c<o;++c){var h=c,p=c+1,d=c+2;p>=o&&(p-=o),d>=o&&(d-=o);var v=new r.Vector(n[p]-n[h],i[p]-i[h]),m=new r.Vector(n[p]-n[d],i[p]-i[d]),g=r.cosine(v,m);g<u&&(u=g,a=p)}if(u>-0.94)break;n.splice(a,1),i.splice(a,1)}if(n.length<4)return t;n.push(n[0]),i.push(i[0]);var y=[];for(var c=0;c<n.length-1;++c)y.push(new f(n[c],i[c],n[c+1],i[c+1],c));y.sort(function(e,t){return t.length2-e.length2}),y.length=4,y.sort(function(e,t){return e.idx-t.idx}),y.push(y[0]);for(var c=0;c<y.length-1;++c){var b=y[c].line.intersect(y[c+1].line);t.x.push(b.x),t.y.push(b.y)}return t.area=l(t),t}function f(e,t,n,r,s){this.idx=s,this.length2=(n-e)*(n-e)+(r-t)*(r-t),this.line=new i(e,t,n,r)}function l(e){var t=0,n=e.x,r=e.y,i=n.length-1;for(var s=0;s<i;++s)t+=n[s+1]*r[s]-n[s]*r[s+1];return t+=n[0]*r[i]-n[i]*r[0],.5*t}function c(e,t){var n=e.x.slice(0),r=e.y.slice(0),s=t.x.slice(0),o=t.y.slice(0);n.push(n[0]),r.push(r[0]),s.push(s[0]),o.push(o[0]);var u;for(var a=0;a<2;++a){for(var f=0;f<n.length-1;++f){var l=new i(n[f],r[f],n[f+1],r[f+1]);for(var c=0;c<s.length-1;++c)if(l.a*s[c]+l.b*o[c]>l.c)break;if(c===s.length-1)return!1}u=n,n=s,s=u,u=r,r=o,o=u}return!0}var r=e("linear_algebra"),i=r.Line;t.Polygon=s,t.findConvexHull=o,t.fitQuadrilateral=a,t.doPolygonsIntersect=c}),n("blob_creation",["require","exports","module","shape","linear_algebra"],function(e,t,n){function u(e,t){s=e,o=t}function a(e){this.label=e,this.pixels=[]}function f(){this.x=[],this.y=[]}function l(e,t,n){var r=e.x.slice(0),s=e.y.slice(0);while(r.length<5)r.push(r[0]),s.push(s[0]);this.a=new i(r[1]-r[0],s[1]-s[0]),this.b=new i(r[2]-r[1],s[2]-s[1]),this.c=new i(r[3]-r[2],s[3]-s[2]),this.d=new i(r[4]-r[3],s[4]-s[3]),this.p=new i(.5*(this.a.x-this.c.x),.5*(this.a.y-this.c.y)),this.q=new i(.5*(this.b.x-this.d.x),.5*(this.b.y-this.d.y)),this.r=new i(t,n)}var r=e("shape"),i=e("linear_algebra").Vector,s,o;l.prototype.toString=function(){var e="",t=["a","b","c","d","p","q","r"];for(var n=0;n<t.length;++n){var r=t[n];e+=r+"= "+this[r].toString();while(e.length%22)e+=" "}return e},a.prototype={get cx(){return this._calculateCentroid(),this.cx},get cy(){return this._calculateCentroid(),this.cy},get edgePoints(){return Object.defineProperty(this,"edgePoints",{value:this._createEdgePoints()}),this.edgePoints},get hull(){return Object.defineProperty(this,"hull",{value:this._createConvexHull()}),this.hull},get quadrilateral(){return Object.defineProperty(this,"quadrilateral",{value:this._createQuadrilateral()}),this.quadrilateral},get feature(){return Object.defineProperty(this,"feature",{value:new l(this.quadrilateral,this.cx,this.cy)}),this.feature},_createEdgePoints:function(){var e=s.width,t=1/e,n=this.pixels,r=new f;for(var i=0;i<n.length;++i){var u=n[i];if(!o[u-1]||!o[u+1]||!o[u-e]||!o[u+e]){var a=u*t|0;r.x.push(u-a*e),r.y.push(a)}}return r},_calculateCentroid:function(){var e=s.width,t=0,n=0,r=this.pixels.length,i=1/e;for(var o=r;o--;){var u=this.pixels[o],a=u*i|0,f=u-a*e;t+=f,n+=a}var l=1/r;Object.defineProperty(this,"cx",{value:t*l}),Object.defineProperty(this,"cy",{value:n*l})},_createConvexHull:function(){var e=this.edgePoints;return r.findConvexHull(e.x,e.y)},_createQuadrilateral:function(){return r.fitQuadrilateral(this.hull)}},t.init=u,t.Blob=a}),n("blob_extraction",["require","exports","module","blob_creation"],function(e,t,n){function i(e){var t=e.data,n=e.width,r=e.height,i=new Uint16Array(e.width*e.height),s=4*n;for(var o=1;o<n-1;++o)for(var u=1;u<r-1;++u){var a=u*n+o,f=a<<2,l=0;for(var c=0;c<3;++c){var h=t[f],p=t[f-4],d=t[f+4],v=t[f-s],m=t[f+s],g=h+p+d+v+m,y=h*h+p*p+d*d+v*v+m*m;l+=.2*y-.04*g*g,++f}l<40&&(i[a]=1)}return i}function s(e,t){var n=t;while(e[t]!==t)t=e[t];while(e[n]!==n)n=e[n],e[n]=t;return t}function o(e,t){var n=0,r=[0],i=e.width,o=e.height;for(var u=1;u<o-1;++u)for(var a=1;a<i-1;++a){var f=u*i+a;if(t[f]){var l=r[t[f-1]],c=r[t[f-i]],h=l+c;l===c?h=l:l&&l<c?r[c]=h=l:c&&c<l&&(r[l]=h=c),h?t[f]=h:(++n,t[f]=n,r[n]=n)}}for(var f=t.length;f--;)t[f]=s(r,t[f]);return t}function u(e,t){r.init(e,t);var n=0,i=[],s=[];for(var o=0;o<t.length;++o){var u=t[o];if(!u)continue;if(!s[u]){var a=new r.Blob(u);a.pixels.push(o),s[u]=n,i[n]=a,++n}else i[s[u]].pixels.push(o)}return i}function a(e){var t=i(e),n=o(e,t),r=u(e,n);return r}var r=e("blob_creation");t.run=a}),n("filter",["require","exports","module"],function(e,t,n){function r(e,t,n){if(!n)return e.filter(t);var r=0;for(var i=0;i<e.length;++i)t(e[i])&&(e[r++]=e[i]);return e.length=r,e}n.exports=r}),n("blob_filtering",["require","exports","module","filter"],function(e,t,n){function i(e,t){var n=t*t,i=n*16e-5,s=n*.14;return r(e,function(e){var t=e.pixels.length;return t>i&&t<s},!0)}function s(e){return r(e,o,!0)}function o(e){var t=e.pixels.length,n=e.quadrilateral.area;return n>0&&t>.8*n}function u(e,t,n){return r(e,function(e){return!a(e,t,n)},!0)}function a(e,t,n){var r=e.edgePoints;for(var i=r.x.length-1;i--;){var s=r.x[i],o=r.y[i];if(s===1||s===t-2||o===1||o===n-2)return!0}return!1}var r=e("filter");t.bySize=i,t.byShape=s,t.onImageEdge=u}),n("blob_coupling",["require","exports","module","linear_algebra","filter"],function(e,t,n){function s(e,t){this.blobs=[e,t];var n=e.feature,r=t.feature;this.angleCost=o(n,r),this.dist=u(n,r),this.calculateNeighborAndRatio(n,r)}function o(e,t){var n=r.cosine,i=4;return i-=n(e.a,t.a),i-=n(e.b,t.b),i-=n(e.c,t.c),i-=n(e.d,t.d),i}function u(e,t){return new r.Vector(t.r.x-e.r.x,t.r.y-e.r.y)}function a(e){var t=[];for(var n=0;n<e.length-1;++n)for(var r=n+1;r<e.length;++r)t.push(new s(e[n],e[r]));return t}function f(e){return i(e,l,!0)}function l(e){return e.angleCost<.4&&e.ratio<2.3}var r=e("linear_algebra"),i=e("filter");s.prototype.toString=function(){var e="";e+="angleCost = "+this.angleCost.toFixed(3);while(e.length%30)e+=" ";e+="dist = "+this.dist.toString();while(e.length%30)e+=" ";e+="ratio = "+this.ratio.toFixed(3);while(e.length%30)e+=" ";return e+="neighbor = "+this.neighbor,e+="\n   "+this.blobs[0].feature.toString(),e+="\n   "+this.blobs[1].feature.toString(),e},s.prototype.calculateNeighborAndRatio=function(e,t){var n=r.vectorAdd,i=r.vectorSubtract,s=[];s.push(n(e.p,t.p)),s.push(n(e.q,t.q)),s.push(n(s[0],s[1])),s.push(i(s[0],s[1]));var o=r.sine2,u=1,a=-1;for(var f=0;f<4;++f){var l=r.sine2(s[f],this.dist);l<u&&(u=l,a=f)}var c=r.magnitude2(this.dist)/r.magnitude2(s[a]);this.ratio=2*Math.sqrt(c),this.neighbor=1<<a},t.createPairs=a,t.filterPairs=f}),n("blob_tripling",["require","exports","module"],function(e,t,n){function r(e,t,n){this.pair1=e,this.pair2=t,this.pair3=n,this.pairs=[e,t,n],this.blobs=[e.blobs[0],e.blobs[1],n.blobs[1]],this.angleCost=e.angleCost+t.angleCost+n.angleCost;var r=e.ratio,i=t.ratio,s=n.ratio;this.ratioCost=r*(r-i)+i*(i-s)+s*(s-r),this.cost=5*this.angleCost+this.ratioCost}function i(e){var t=[];for(var n=0;n<e.length-2;++n){var i=e[n],u=i.blobs[0],a=i.blobs[1];for(var f=n+1;f<e.length-1;++f){var l=e[f];if(l.blobs[0]!==u)break;if(i.neighbor===l.neighbor)continue;var c=l.blobs[1];for(var h=f+1;h<e.length;++h){var p=e[h],d=i.neighbor+l.neighbor+p.neighbor;p.blobs[0]===a&&p.blobs[1]===c&&(d===7||d===11)&&s(u,a,c)&&t.push(new r(i,l,p))}}}return t.sort(o),t}function s(e,t,n){var r=e.pixels.length,i=t.pixels.length,s=n.pixels.length;return Math.min(r,i,s)>.2*Math.max(r,i,s)}function o(e,t){return e.cost-t.cost}r.prototype.toString=function(){var e="";e+="blob1 = "+this.blobs[0].cx.toFixed(3)+", "+this.blobs[0].cy.toFixed(3);while(e.length%28)e+=" ";e+="blob2 = "+this.blobs[1].cx.toFixed(3)+", "+this.blobs[1].cy.toFixed(3);while(e.length%28)e+=" ";e+="blob3 = "+this.blobs[2].cx.toFixed(3)+", "+this.blobs[2].cy.toFixed(3);while(e.length%28)e+=" ";e+="angleCost = "+this.angleCost.toFixed(3);while(e.length%28)e+=" ";e+="ratioCost = "+this.ratioCost.toFixed(3);while(e.length%28)e+=" ";return e+="cost = "+this.cost.toFixed(3),e},t.createTriples=i}),n("blob_quadrupling",["require","exports","module"],function(e,t,n){function r(e,t){this.blobs=i(e,t),this.triples=[e,t],this.angleCost=Math.max(e.angleCost,t.angleCost),this.ratioCost=Math.max(e.ratioCost,t.ratioCost),this.cost=Math.max(e.cost,t.cost)}function i(e,t){var n=e.blobs.concat(t.blobs);return n=n.filter(s),n.sort(o),n}function s(e,t,n){return n.indexOf(e)===t}function o(e,t){return e.label-t.label}function u(e,t){var n=new Array(3),r=new Array(3);n[e.pair1.neighbor&3]=e.pair1,n[e.pair2.neighbor&3]=e.pair2,n[e.pair3.neighbor&3]=e.pair3,r[t.pair1.neighbor&3]=t.pair1,r[t.pair2.neighbor&3]=t.pair2,r[t.pair3.neighbor&3]=t.pair3;var i=a;return n[0]===r[0]&&!i(n[1],r[1])||n[0].neighbor!==r[0].neighbor&&(n[1]===r[1]&&!i(n[2],r[2])||n[2]===r[2]&&!i(n[1],r[1]))}function a(e,t){var n=e.blobs,r=t.blobs;return n[0]===r[0]||n[0]===r[1]||n[1]===r[0]||n[1]===r[1]}function f(e){var t=[];for(var n=0;n<e.length-1;++n)for(var i=n+1;i<e.length;++i)u(e[n],e[i])&&t.push(new r(e[n],e[i]));return l(t)}function l(e){var t=[];for(var n=0;n<e.length-1;++n){var r=e[n];if(!r)continue;for(var i=n+1;i<e.length;++i){var s=e[i];s&&c(r,s)&&(r.merge(s),e[i]=0)}t.push(r)}return t}function c(e,t){var n=e.blobs,r=t.blobs;return n[0]===r[0]&&n[1]===r[1]&&n[2]===r[2]&&n[3]===r[3]}r.prototype.merge=function(e){this.angleCost=Math.max(e.angleCost,this.angleCost),this.ratioCost=Math.max(e.ratioCost,this.ratioCost),this.cost=Math.max(e.cost,this.cost);for(var t=0;t<e.triples.length;++t){var n=e.triples[t];this.triples.indexOf(n)===-1&&this.triples.push(n)}return this},r.prototype.toString=function(){var e="";e+="blob1 = "+this.blobs[0].label;while(e.length%22)e+=" ";e+="blob2 = "+this.blobs[1].label;while(e.length%22)e+=" ";e+="blob3 = "+this.blobs[2].label;while(e.length%22)e+=" ";e+="blob4 = "+this.blobs[3].label;while(e.length%22)e+=" ";e+="angleCost = "+this.angleCost.toFixed(3);while(e.length%22)e+=" ";e+="ratioCost = "+this.ratioCost.toFixed(3);while(e.length%22)e+=" ";return e+="cost = "+this.cost.toFixed(3),e},t.createQuadruples=f}),n("cubeface_creation",["require","exports","module","shape","linear_algebra"],function(e,t,n){function a(e,t){this.hull=this.calculateConvexHull(e),this.quadrilateral=r.fitQuadrilateral(this.hull),this.centroid=l(this.quadrilateral);var n=f(t,e);this.blobs=n?n.blobs.slice(0):e.blobs.slice(0),this.angleCost=n?n.angleCost:e.angleCost,this.cost=this.angleCost}function f(e,t){if(!e)return;for(var n=0;n<e.length;++n)if(e[n].triples.indexOf(t)!==-1)return e[n]}function l(e){var t=e,n=.25*(t.x[0]+t.x[1]+t.x[2]+t.x[3]),r=.25*(t.y[0]+t.y[1]+t.y[2]+t.y[3]);return new o(n,r)}function c(e,t){return e.y<t.y?-1:e.y>t.y?1:e.x<t.x?-1:e.x>t.x?1:0}function h(e,t){for(var n=0;e.pairs[n].neighbor<3;++n);var r=e.blobs[2-n],i=e.pairs[n].blobs[0],o=e.pairs[n].blobs[1],a=i.quadrilateral.x.slice(0),f=i.quadrilateral.y.slice(0),l=o.quadrilateral.x.slice(0),c=o.quadrilateral.y.slice(0),h=[];a.push(a[0]),f.push(f[0]),l=l.concat(l),c=c.concat(c);for(var n=0;n<4;++n){var d=a[n],v=f[n],m=a[n+1],g=f[n+1];h.push(p(d,v,m,g,l[n+1],c[n+1],l[n+2],c[n+2])),h.push(p(d,v,m,g,l[n+3],c[n+3],l[n+4],c[n+4]))}var y=new s(o.cx-i.cx,o.cy-i.cy),b=new s(r.cx-i.cx,r.cy-i.cy),w=new s(h[0].x-i.cx,h[0].y-i.cy);u(y,b)*u(y,w)<0?t.push(h[0],h[1],h[4],h[5]):t.push(h[2],h[3],h[6],h[7])}function p(e,t,n,r,i,s,u,a){var f=r-t,l=a-s,c=e-n,h=i-u,p=e*r-n*t,d=i*a-u*s,v=1/(f*h-c*l),m=p*h-d*c,g=d*f-p*l;return new o(m*v,g*v)}function d(e,t){var n=t.blobs;for(var r=0;r<e.length;++r){var i=e[r].blobs;if(n[0]===i[0]&&n[1]===i[1]&&n[2]===i[2]&&n[3]===i[3])return!0}return!1}function v(e,t){var n=[];for(var r=0;r<e.length;++r){var i=new a(e[r],t);d(n,i)||n.push(i)}return n}var r=e("shape"),i=e("linear_algebra"),s=i.Vector,o=i.Point,u=i.crossProductVal;a.prototype.calculateConvexHull=function(e){var t=e.blobs,n=[];for(var i=0;i<t.length;++i){var s=t[i].hull;for(var u=0;u<s.x.length;++u)n.push(new o(s.x[u],s.y[u]))}h(e,n),n.sort(c);var a=[],f=[];for(var i=0;i<n.length;++i)a.push(n[i].x),f.push(n[i].y);return r.findConvexHull(a,f)},t.createCubeFaces=v}),n("cubeface_coupling",["require","exports","module","filter","linear_algebra","shape"],function(e,t,n){function a(e,t){this.face1=e,this.face2=t;var n=1e9;this.angleCost=n,this.edgeLengthCost=n,this.edgeDistance=n,this.centroidDistance=n,this.cost=n,this.face1Index=-1,this.face2Index=-1,this.getCosts(e,t),this.cost=5*this.edgeDistance+25e3*this.angleCost+this.centroidDistance+100*this.edgeLengthCost+10*(8-this.face1.blobs.length-this.face2.blobs.length)}function f(e,t,n,r){var o=new l(1e6,0,0,[],[]);for(var u=0;u<4;++u)for(var a=0;a<4;++a){var f=[e[u],e[u+1],n[a+1],n[a]],c=[t[u],t[u+1],r[a+1],r[a]],h=new s(f[2]+f[3]-f[0]-f[1],c[2]+c[3]-c[0]-c[1]),p=i.magnitude2(h);p<o.d&&(o=new l(p,u,a,f,c))}return o}function l(e,t,n,r,i){this.d=e,this.i=t,this.j=n,this.x=r,this.y=i}function c(e,t){var n=new s(e[1]-e[0],t[1]-t[0]),r=new s(e[3]-e[2],t[3]-t[2]);return 1-i.cosine(n,r)}function h(e,t){var n=new s(e[1]-e[0],t[1]-t[0]),r=new s(e[3]-e[2],t[3]-t[2]),i=o(n),u=o(r);return i>u?1-u/i:1-i/u}function p(e,t){var n=new i.Line(e[0],t[0],e[1],t[1]);return n.distance(.5*(e[2]+e[3]),.5*(t[2]+t[3]))}function d(e,t){var n=e.centroid,r=t.centroid;return o(new s(r.x-n.x,r.y-n.y))}function v(e){var t=[];for(var n=0;n<e.length-1;++n){var r=e[n];for(var i=n+1;i<e.length;++i){var s=e[i];u.doPolygonsIntersect(r.quadrilateral,s.quadrilateral)||t.push(new a(e[n],e[i]))}}return t}function m(e){return r(e,function(e){return e.angleCost<.034&&e.edgeLengthCost<.35&&e.edgeDistance<28&&e.edgeDistance<.5*e.centroidDistance},!0)}var r=e("filter"),i=e("linear_algebra"),s=i.Vector,o=i.magnitude,u=e("shape");a.prototype.toString=function(){var e="";e+="angleCost = "+this.angleCost.toFixed(3);while(e.length%28)e+=" ";e+="edgeLengthCost = "+this.edgeLengthCost.toFixed(3);while(e.length%28)e+=" ";e+="distance = "+this.distance.toFixed(3);while(e.length%28)e+=" ";return e},a.prototype.getCosts=function(e,t){var n=e.quadrilateral.x.slice(0),r=e.quadrilateral.y.slice(0),i=t.quadrilateral.x.slice(0),s=t.quadrilateral.y.slice(0);n=n.concat(n[0]),r=r.concat(r[0]),i=i.concat(i[0]),s=s.concat(s[0]);var o=f(n,r,i,s);this.angleCost=c(o.x,o.y),this.edgeLengthCost=h(o.x,o.y),this.edgeDistance=p(o.x,o.y),this.centroidDistance=d(e,t),this.face1Index=o.i,this.face2Index=o.j},t.createPairs=v,t.filterPairs=m}),n("cubeface_tripling",["require","exports","module"],function(e,t,n){function r(e,t,n){this.pair1=e,this.pair2=t,this.pair3=n,this.face1=e.face1,this.face2=e.face2,this.face3=t.face1===this.face1||t.face1===this.face2?t.face2:t.face1;var r=e.edgeDistance+t.edgeDistance+n.edgeDistance,i=e.edgeLengthCost*e.edgeLengthCost+t.edgeLengthCost*t.edgeLengthCost+n.edgeLengthCost*n.edgeLengthCost;this.cost=200*i+r}function i(e,t){return e.face1===t.face1||e.face1===t.face2||e.face2===t.face1||e.face2===t.face2}function s(e,t){var n;n=e.face1;if(n===t.face1||n===t.face2)return n;n=e.face2;if(n===t.face1||n===t.face2)return n}function o(e){var t=[];for(var n=0;n<e.length-2;++n){var i=e[n];for(var o=n+1;o<e.length-1;++o){var u=e[o];if(!s(i,u))continue;for(var a=o+1;a<e.length;++a){var f=e[a],l=s(i,f),c=s(u,f);if(!l||!c||l===c)continue;t.push(new r(i,u,f))}}}return t}t.createTriples=o}),n("image_analyzer",["require","exports","module","blob_extraction","blob_filtering","blob_coupling","blob_tripling","blob_quadrupling","cubeface_creation","cubeface_coupling","cubeface_tripling"],function(e,t,n){function c(e){var t=new Date,n=r.run(e);n=i.bySize(n,e.width),n=i.onImageEdge(n,e.width,e.height),n=i.byShape(n);var c=s.createPairs(n);c=s.filterPairs(c);var p=o.createTriples(c),d=u.createQuadruples(p),v=a.createCubeFaces(p,d),m=f.createPairs(v);m=f.filterPairs(m);var g=l.createTriples(m);return new h(e,n,c,p,d,v,m,g,t)}function h(e,t,n,r,i,s,o,u,a){this.imageData=e,this.blobs=t,this.blobPairs=n,this.blobTriples=r,this.blobQuadruples=i,this.faces=s,this.facePairs=o,this.faceTriples=u,this.time=new Date-a}var r=e("blob_extraction"),i=e("blob_filtering"),s=e("blob_coupling"),o=e("blob_tripling"),u=e("blob_quadrupling"),a=e("cubeface_creation"),f=e("cubeface_coupling"),l=e("cubeface_tripling");t.run=c}),importScripts("require.js"),t(["image_analyzer"],function(){var e=t("image_analyzer");self.addEventListener("message",function(t){var n=t.data.imageData,r=e.run(n);self.postMessage(r)},!1)}),n("worker.js",function(){})})();